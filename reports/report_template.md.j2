{# =========================== SETTINGS =========================== #}
{# Максимальная длина однострочного фрагмента output в таблицах #}
{% set OUTPUT_TRIM = 200 %}

{# =========================== HELPERS ============================ #}
{% macro norm_status(r) -%}
  {%- set s = (r.status if r.status is defined else r.result|default('')) -%}
  {%- set s = s|string -%}
  {%- if s|lower in ['pass','ok','success'] or s == 'PASS' -%}pass
  {%- elif s|lower in ['fail','failed'] or s == 'FAIL' -%}fail
  {%- elif s|lower in ['error','err'] -%}error
  {%- else -%}unknown
  {%- endif -%}
{%- endmacro %}

{% macro status_badge(s) -%}
  {%- set s = s|lower -%}
  {%- if s == 'pass' -%}✅ Пройдено
  {%- elif s == 'fail' -%}❌ Не пройдено
  {%- elif s == 'error' -%}⚠️ Ошибка
  {%- else -%}❔ Неопределён
  {%- endif -%}
{%- endmacro %}

{% macro sev_badge(sev) -%}
  {%- set v = (sev|string|lower) -%}
  {%- if v == 'high' -%}**🔴 HIGH**
  {%- elif v == 'medium' -%}🟠 Medium
  {%- elif v == 'low' -%}🟢 Low
  {%- else -%}n/a
  {%- endif -%}
{%- endmacro %}

{# Преобразуем tags.fstec в список кодов мер №21 #}
{% macro fstec_list(r) -%}
  {%- if r.tags is not defined or not r.tags or ('fstec' not in r.tags) -%}[]{% else -%}
    {%- set raw = r.tags.fstec -%}
    {%- if raw is string -%}[{{ raw }}]{% elif raw is sequence -%}{{ raw }}{% else -%}[]{% endif -%}
  {%- endif -%}
{%- endmacro %}

{# Человеческая расшифровка мер №21 (топ-подмножество; можно расширять) #}
{% set FSTEK21 = {
  'ИАФ.1':'Идентификация/аутентификация работников',
  'ИАФ.2':'Идентификация/аутентификация устройств',
  'ИАФ.3':'Управление идентификаторами',
  'ИАФ.4':'Управление средствами аутентификации',
  'ИАФ.5':'Защита обратной связи при вводе',
  'ИАФ.6':'ИА внешних пользователей',

  'УПД.1':'Управление учётными записями',
  'УПД.2':'Разграничение доступа',
  'УПД.3':'Управление инфопотоками',
  'УПД.4':'Разделение ролей',
  'УПД.5':'Минимальные привилегии',
  'УПД.6':'Ограничение неуспешных входов',
  'УПД.7':'Баннер безопасности',
  'УПД.8':'Оповещение о предыдущем входе',
  'УПД.9':'Лимит параллельных сессий',
  'УПД.10':'Таймаут сессии',
  'УПД.11':'Права до аутентификации',
  'УПД.12':'Атрибуты безопасности',
  'УПД.13':'Защищённый удалённый доступ',
  'УПД.14':'Контроль Wi-Fi',
  'УПД.15':'Контроль мобильных ТС',
  'УПД.16':'Внешние ИС',
  'УПД.17':'Доверенная загрузка',

  'ОПС.1':'Управление запуском ПО',
  'ОПС.2':'Управление установкой ПО',
  'ОПС.3':'Только разрешённое ПО',
  'ОПС.4':'Управление временными файлами',

  'ЗНИ.1':'Учёт носителей ПДн',
  'ЗНИ.2':'Доступ к носителям ПДн',
  'ЗНИ.3':'Контроль перемещения носителей',
  'ЗНИ.4':'Исключить НСД к ПДн на носителях',
  'ЗНИ.5':'Контроль интерфейсов ввода/вывода',
  'ЗНИ.6':'Контроль ввода/вывода',
  'ЗНИ.7':'Контроль подключения носителей',
  'ЗНИ.8':'Уничтожение/обезличивание ПДн',

  'РСБ.1':'События и сроки хранения',
  'РСБ.2':'Состав записей',
  'РСБ.3':'Сбор/запись/хранение',
  'РСБ.4':'Сбои регистрации',
  'РСБ.5':'Мониторинг журналов',
  'РСБ.6':'Синхронизация времени',
  'РСБ.7':'Защита информации о событиях',

  'АВЗ.1':'Антивирусная защита',
  'АВЗ.2':'Обновление сигнатур',

  'СОВ.1':'Обнаружение вторжений',
  'СОВ.2':'Обновление правил',

  'АНЗ.1':'Управление уязвимостями',
  'АНЗ.2':'Контроль обновлений',
  'АНЗ.3':'Контроль СЗИ/настроек',
  'АНЗ.4':'Контроль состава ТС/ПО/СЗИ',
  'АНЗ.5':'Контроль паролей/аккаунтов/ролей',

  'ОЦЛ.1':'Целостность ПО',
  'ОЦЛ.2':'Целостность ПДн в БД',
  'ОЦЛ.3':'Восстановление ПО',
  'ОЦЛ.4':'Защита от спама',
  'ОЦЛ.5':'Контроль исходящего контента',
  'ОЦЛ.6':'Ограничение прав ввода',
  'ОЦЛ.7':'Точность вводимых данных',
  'ОЦЛ.8':'Предупреждение об ошибках',

  'ОДТ.1':'Отказоустойчивые ТС',
  'ОДТ.2':'Резервирование',
  'ОДТ.3':'Контроль безотказности',
  'ОДТ.4':'Бэкап ПДн',
  'ОДТ.5':'Восстановление ПДн',

  'ЗСВ.1':'ИАФ в ВИ',
  'ЗСВ.2':'Доступ в ВИ',
  'ЗСВ.3':'Журналы в ВИ',
  'ЗСВ.4':'Потоки/периметр ВИ',
  'ЗСВ.5':'Доверенная загрузка в ВИ',
  'ЗСВ.6':'Миграция ВМ/контейнеров',
  'ЗСВ.7':'Целостность ВИ/конфигураций',
  'ЗСВ.8':'Резерв в ВИ',
  'ЗСВ.9':'Антивирус в ВИ',
  'ЗСВ.10':'Сегментирование ВИ',

  'ЗТС.1':'Утечки по ТКУ',
  'ЗТС.2':'Контролируемая зона',
  'ЗТС.3':'Физический доступ',
  'ЗТС.4':'Размещение дисплеев',
  'ЗТС.5':'Внешние воздействия',

  'ЗИС.1':'Разделение функций',
  'ЗИС.2':'Приоритетные процессы',
  'ЗИС.3':'Защита ПДн при передаче',
  'ЗИС.4':'Доверенные каналы/маршруты',
  'ЗИС.5':'Запрет удалённой периферии',
  'ЗИС.6':'Атрибуты безопасности при обмене',
  'ЗИС.7':'Мобильный код',
  'ЗИС.8':'Передача речи',
  'ЗИС.9':'Видеоинформация',
  'ЗИС.10':'Происхождение имён/адресов',
  'ЗИС.11':'Подлинность соединений',
  'ЗИС.12':'Неотрекаемость отправки',
  'ЗИС.13':'Неотрекаемость получения',
  'ЗИС.14':'Терминальный доступ',
  'ЗИС.15':'Защита архивов/настроек',
  'ЗИС.16':'Скрытые каналы',
  'ЗИС.17':'Сегментирование ИС',
  'ЗИС.18':'Чтение-только носители + целостность',
  'ЗИС.19':'Изоляция процессов',
  'ЗИС.20':'Защита беспроводных соединений'
} %}

{# Утилита: короткая строка output #}
{% macro short_output(text) -%}
  {{ (text|default('')|replace('\n',' ')|trim|truncate(OUTPUT_TRIM, True)) }}
{%- endmacro %}

{# =========================== HEADER ============================ #}
# Отчёт SecAudit++

**Профиль:** {{ (profile.profile_name if profile is defined and profile.profile_name is defined else profile_name|default('—')) }}  
**Описание:** {{ (profile.description if profile is defined and profile.description is defined else profile_description|default('—')) }}  
**Дата проведения:** {{ (now.strftime("%Y-%m-%d %H:%M:%S") if now is defined else timestamp|default('—')) }}

---

{# ========================= KPI / SUMMARY ======================== #}
{% set _statuses = results | map('norm_status') if false else [] %}
{% set total = results|length %}
{% set passed = results|selectattr('status','equalto','pass')|list|length %}
{% if passed == 0 %}
  {# Вход может содержать 'result' вместо 'status' — подстрахуемся: #}
  {% set passed = results|selectattr('result','equalto','PASS')|list|length %}
{% endif %}
{% set failed = results|selectattr('status','equalto','fail')|list|length %}
{% if failed == 0 %}
  {% set failed = results|selectattr('result','equalto','FAIL')|list|length %}
{% endif %}
{% set errors = results|selectattr('status','equalto','error')|list|length %}
{% set unknown = total - passed - failed - errors %}
{% set compliance = (100.0 * passed / total) | round(1) if total > 0 else 0 %}

**Итоги:** всего **{{ total }}**, ✅ пройдено **{{ passed }}**, ❌ не пройдено **{{ failed }}**, ⚠️ ошибок **{{ errors }}**, ❔ прочее **{{ unknown }}**.  
**Индекс соответствия:** **{{ compliance }}%**

---

{# =================== ГРУППИРОВКА ПО МОДУЛЯМ ==================== #}
{% for module, checks in results | groupby('module') %}
## Модуль: {{ module | capitalize }} ({{ checks | length }} проверок)

| № | Проверка | Severity | FSTEK №21 | Assert | Результат | Ожидание | Факт (фрагмент) |
|---|---|---|---|---|---|---|---|
{% for check in checks %}
  {% set s = norm_status(check) %}
  {% set fl = fstec_list(check) %}
| {{ loop.index }} | {{ check.name }} | {{ sev_badge(check.severity) }} | 
  {%- if fl|length > 0 -%} {{ fl|join(', ') }} {%- else -%} — {%- endif -%} |
  `{{ check.assert_type|default('exact') }}` | {{ status_badge(s) }} |
  `{{ check.expect|default('') }}` |
  `{{ short_output(check.output) }}` |
{% endfor %}

{% endfor %}

---

{# ============== СВОДКА ПО МЕРАМ ФСТЭК №21 (если есть) ============== #}
{% set seen = {} %}
{% for r in results %}
  {% for m in fstec_list(r) %}
    {% set _ = seen.update({m: (seen.get(m, []) + [r])}) %}
  {% endfor %}
{% endfor %}

{% if seen %}
## Сводка по мерам ФСТЭК №21
| Мера | Описание | Всего | ✅ Pass | ❌ Fail | ⚠️ Error |
|---|---|---:|---:|---:|---:|
{% for m, rs in seen|dictsort %}
  {% set p = rs | selectattr('status','equalto','pass')  | list | length %}
  {% if p == 0 %}{% set p = rs | selectattr('result','equalto','PASS') | list | length %}{% endif %}
  {% set f = rs | selectattr('status','equalto','fail')  | list | length %}
  {% if f == 0 %}{% set f = rs | selectattr('result','equalto','FAIL') | list | length %}{% endif %}
  {% set e = rs | selectattr('status','equalto','error') | list | length %}
| **{{ m }}** | {{ FSTEK21.get(m, '—') }} | {{ rs|length }} | {{ p }} | {{ f }} | {{ e }} |
{% endfor %}
{% else %}
_Теги ФСТЭК №21 в проверках отсутствуют._
{% endif %}

---

{# ============== КРИТИЧЕСКИЕ НЕСООТВЕТСТВИЯ (HIGH) ============== #}
{% set highs = results
  | selectattr('severity','equalto','high')
  | selectattr('status','equalto','fail') | list %}
{% if highs|length == 0 %}
  {# fallback на поле result #}
  {% set highs = results
    | selectattr('severity','equalto','high')
    | selectattr('result','equalto','FAIL') | list %}
{% endif %}

## Критические несоответствия (High)
{% if highs %}
{% for r in highs %}
- **{{ r.name }}** (`{{ r.id }}`)
  - Модуль: `{{ r.module }}`
  - Меры №21: 
    {%- set fl = fstec_list(r) -%}
    {%- if fl|length > 0 -%} {{ fl|join(', ') }} — {{ fl | map('string') | map('trim') | map('upper') | list | map('attr', FSTEK21) | list | reject('equalto', None) | list | join('; ') }}
    {%- else -%} — {%- endif -%}
  - Ожидание: `{{ r.expect|default('') }}`
  - Assert: `{{ r.assert_type|default('exact') }}`
  - Команда:
    ```bash
    {{ r.command }}
    ```
  - Фактический вывод:
    ```
    {{ r.output|default('')|trim }}
    ```
{% endfor %}
{% else %}
_Критических несоответствий не выявлено._
{% endif %}

---

{# ======================== КОНТЕКСТ ХОСТА ======================== #}
## Системная информация
- Хост: **{{ host.hostname|default('—') }}**
- ОС: **{{ host.os|default('—') }}**
- Ядро: **{{ host.kernel|default('—') }}**
- Архитектура: **{{ host.arch|default('—') }}**
- Время генерации: **{{ (now.strftime("%Y-%m-%d %H:%M:%S") if now is defined else timestamp|default('—')) }}**

{# ============================= END ============================= #}
