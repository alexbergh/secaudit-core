<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–û—Ç—á—ë—Ç SecAudit++</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .code-pre {
      white-space: pre-wrap;
      word-break: break-word;
      background-color: #f8f9fa;
      color: #212529;
      border: 1px solid #dee2e6;
      border-radius: .375rem;
      padding: .75rem;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small-mono { font-size: .875rem; }
    .table-sm td, .table-sm th { vertical-align: middle; }
    .badge-pill { border-radius: 1rem; }
    .sticky-header thead th { position: sticky; top: 0; z-index: 2; background-color: var(--bs-body-bg); }
    .filters .form-label { font-size: .8rem; text-transform: uppercase; letter-spacing: .08em; }
    @media print {
      body { background: #ffffff !important; color: #000000 !important; }
      .no-print { display: none !important; }
      a { color: #000 !important; text-decoration: none !important; }
    }
    @media (prefers-color-scheme: dark) {
      body { background-color: #111417; color: #e7eaef; }
      .card { background-color: #1b1f24; color: inherit; border-color: #2b3036; }
      .accordion-button { background-color: #1b1f24; color: inherit; }
      .accordion-button:not(.collapsed) { background-color: #242933; color: inherit; }
      .table { color: inherit; }
      .table thead th { background-color: #2b3036; color: #f8f9fa; }
      .badge.bg-info { color: #0b1727 !important; }
      .code-pre { background-color: #0f1115; color: #f5f7fa; border-color: #2b3036; }
      .text-muted { color: #9aa5b3 !important; }
    }
  </style>
</head>
<body>
  {# =========================== SETTINGS =========================== #}
  {% set OUTPUT_TRIM = 400 %}

  {# =========================== HELPERS ============================ #}
  {% macro norm_status(r) -%}
    {%- set s = (r.status if r.status is defined else r.result|default('')) -%}
    {%- set s = s|string -%}
    {%- if s|lower in ['pass','ok','success'] or s == 'PASS' -%}pass
    {%- elif s|lower in ['fail','failed'] or s == 'FAIL' -%}fail
    {%- elif s|lower in ['error','err'] -%}error
    {%- else -%}unknown
    {%- endif -%}
  {%- endmacro %}

  {% macro sev_badge(sev) -%}
    {%- set v = (sev|string|lower) -%}
    {%- if v == 'high' -%}<span class="badge bg-danger">HIGH</span>
    {%- elif v == 'medium' -%}<span class="badge bg-warning text-dark">Medium</span>
    {%- elif v == 'low' -%}<span class="badge bg-success">Low</span>
    {%- else -%}<span class="badge bg-secondary">n/a</span>
    {%- endif -%}
  {%- endmacro %}

  {% macro result_badge(s) -%}
    {%- set s = s|lower -%}
    {%- if s == 'pass' -%}<span class="text-success fw-semibold">–£—Å–ø–µ—à–Ω–æ</span>
    {%- elif s == 'fail' -%}<span class="text-danger fw-semibold">–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ</span>
    {%- elif s == 'error' -%}<span class="text-warning fw-semibold">–û—à–∏–±–∫–∞</span>
    {%- else -%}<span class="text-muted">–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω</span>
    {%- endif -%}
  {%- endmacro %}

  {% macro short_output(text) -%}
    {{ (text|default('')|replace('\r','')|trim|truncate(OUTPUT_TRIM, True)) }}
  {%- endmacro %}

  {% macro format_expect(value) -%}
    {%- if value is mapping or (value is sequence and (value is not string)) -%}
      {{ value|tojson(ensure_ascii=False) }}
    {%- else -%}
      {{ value|default('') }}
    {%- endif -%}
  {%- endmacro %}

  {% set FSTEK21 = FSTEK21 | default({}, true) %}

{% macro fstec_badges(details) -%}
  {%- if details and details|length > 0 -%}
    {%- for item in details -%}
      {%- if not loop.first -%}, {% endif -%}
      {%- if item.code -%}<span class="badge bg-info text-dark">{{ item.code }}</span>{%- endif -%}
    {%- endfor -%}
  {%- else -%}
    ‚Äî
  {%- endif -%}
{%- endmacro %}

{% macro fstec_summary(details) -%}
  {%- if details and details|length > 0 -%}
    {%- for item in details -%}
      {%- if not loop.first -%}; {% endif -%}
      {%- set code = item.code|string -%}
      {%- set desc = item.description -%}
      {%- if desc -%}
        <strong>{{ desc }}</strong> <span class="text-muted">({{ code }})</span>
      {%- else -%}
        {{ code }}
      {%- endif -%}
    {%- endfor -%}
  {%- else -%}
    ‚Äî
  {%- endif -%}
{%- endmacro %}

  {# ======================== KPI / SUMMARY ======================== #}
  {% set total = total_count|default(results|length) %}
  {% set passed = pass_count|default(0) %}
  {% set failed = fail_count|default(0) %}
  {% set warnings = warn_count|default(0) %}
  {% set errors = error_count|default(0) %}
  {% set other = other_count|default(total - passed - failed - warnings - errors) %}
  {% set compliance = (100.0 * passed / total) | round(1) if total > 0 else 0 %}

  <div class="container my-4">
    <h1 class="mb-3">–û—Ç—á—ë—Ç SecAudit++</h1>

    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-8">
        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-wrap gap-4">
              <div><div class="text-muted small">–ü—Ä–æ—Ñ–∏–ª—å</div><div class="fw-semibold">{{ (profile.profile_name if profile is defined and profile.profile_name is defined else profile_name|default('‚Äî')) }}</div></div>
              <div><div class="text-muted small">–û–ø–∏—Å–∞–Ω–∏–µ</div><div>{{ (profile.description if profile is defined and profile.description is defined else profile_description|default('‚Äî')) }}</div></div>
              <div><div class="text-muted small">–î–∞—Ç–∞</div><div>{{ (now.strftime("%Y-%m-%d %H:%M:%S") if now is defined else timestamp|default('‚Äî')) }}</div></div>
              {% set host_info = host if host is defined else {} %}
              {% set raw_ip = host_info.ip if host_info.ip is defined else
                              (host_info.ipv4 if host_info.ipv4 is defined else
                              (host_info.address if host_info.address is defined else
                              (host_info.ip_address if host_info.ip_address is defined else
                              None))) %}
              {% if raw_ip is sequence and (raw_ip is not string) %}
                {% set host_ip = raw_ip|join(', ') %}
              {% elif raw_ip is mapping %}
                {% set host_ip = raw_ip|tojson(ensure_ascii=False) %}
              {% else %}
                {% set host_ip = raw_ip|default('‚Äî', true) %}
              {% endif %}
              {% if host_ip is not defined or host_ip|string|trim == '' %}
                {% set host_ip = '‚Äî' %}
              {% endif %}
              <div><div class="text-muted small">–•–æ—Å—Ç</div><div>{{ host_info.hostname|default('‚Äî') }}</div></div>
              <div><div class="text-muted small">IP-–∞–¥—Ä–µ—Å</div><div>{{ host_ip }}</div></div>
              <div><div class="text-muted small">–û–°</div><div>{{ host_info.os|default('‚Äî') }}</div></div>
              <div><div class="text-muted small">–Ø–¥—Ä–æ</div><div>{{ host_info.kernel|default('‚Äî') }}</div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="row text-center g-3">
              <div class="col">
                <div class="text-muted small">–í—Å–µ–≥–æ</div>
                <div class="fs-4 fw-bold">{{ total }}</div>
              </div>
              <div class="col">
                <div class="text-muted small">‚úÖ Pass</div>
                <div class="fs-4 text-success fw-bold">{{ passed }}</div>
              </div>
              <div class="col">
                <div class="text-muted small">‚ùå Fail</div>
                <div class="fs-4 text-danger fw-bold">{{ failed }}</div>
              </div>
              <div class="col">
                <div class="text-muted small">üö® Errors</div>
                <div class="fs-4 text-warning fw-bold">{{ errors }}</div>
              </div>
            </div>
            <hr/>
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted small">–ò–Ω–¥–µ–∫—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</div>
              <div class="fs-5 fw-bold">{{ compliance }}%</div>
            </div>
            <div class="progress mt-2" role="progressbar" aria-valuenow="{{ compliance }}" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar" style="width: {{ compliance }}%"></div>
            </div>
            <div class="d-flex justify-content-between align-items-center text-muted small mt-3">
              <span>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</span>
              <span class="fw-semibold">{{ warnings }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center text-muted small">
              <span>‚ùî –ü—Ä–æ—á–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π</span>
              <span class="fw-semibold">{{ other }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4 shadow-sm no-print filters">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-4 col-xl-3">
            <label class="form-label" for="filter-search">–ü–æ–∏—Å–∫</label>
            <input type="search" class="form-control" id="filter-search" placeholder="ID –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ" />
          </div>
          <div class="col-6 col-md-4 col-xl-2">
            <label class="form-label" for="filter-severity">Severity</label>
            <select class="form-select" id="filter-severity">
              <option value="all">–í—Å–µ</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="col-6 col-md-4 col-xl-2">
            <label class="form-label" for="filter-status">–°—Ç–∞—Ç—É—Å</label>
            <select class="form-select" id="filter-status">
              <option value="all">–í—Å–µ</option>
              <option value="pass">PASS</option>
              <option value="fail">FAIL</option>
              <option value="error">ERROR</option>
              <option value="unknown">UNDEF</option>
            </select>
          </div>
          <div class="col-12 col-md-4 col-xl-3">
            <label class="form-label" for="filter-tags">–¢–µ–≥–∏</label>
            <input type="text" class="form-control" id="filter-tags" placeholder="fstec:—É–ø–¥.7, cis:5.2" />
          </div>
          <div class="col-12 col-md-4 col-xl-2 text-md-end">
            <div class="d-flex gap-2 flex-column flex-md-row">
              <button type="button" class="btn btn-outline-secondary w-100" id="export-csv">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
              <button type="button" class="btn btn-outline-secondary w-100" id="export-json">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# =================== –ú–û–î–£–õ–ò (–ê–ö–ö–û–†–î–ï–û–ù) =================== #}
    <div class="accordion" id="modulesAccordion">
      {% for module, checks in results | groupby('module') %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ loop.index }}">
          <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-{{ loop.index }}"
                  aria-expanded="{{ 'true' if loop.first else 'false' }}"
                  aria-controls="collapse-{{ loop.index }}">
            –ú–æ–¥—É–ª—å: {{ module | capitalize }} ({{ checks | length }} –ø—Ä–æ–≤–µ—Ä–æ–∫)
          </button>
        </h2>
        <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
             aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#modulesAccordion">
          <div class="accordion-body">

            {% set module_idx = loop.index %}
            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle sticky-header">
                <thead class="table-light">
                  <tr>
                    <th style="width:3ch;">#</th>
                    <th>–ü—Ä–æ–≤–µ—Ä–∫–∞</th>
                    <th style="width:9ch;">Sev</th>
                    <th style="width:10ch;">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    <th style="width:12ch;">Assert</th>
                    <th>–û–∂–∏–¥–∞–Ω–∏–µ</th>
                    <th>–§–°–¢–≠–ö ‚Ññ21</th>
                    <th style="width:1%"></th>
                  </tr>
                </thead>
                <tbody>
                {% for check in checks %}
                  {% set s = norm_status(check) %}
                  {% set fl = check|fstek_details %}
                  {% set expect_display = format_expect(check.expect) %}
                  {% set tag_strings = [] %}
                  {% if check.tags %}
                    {% for key, value in check.tags.items() %}
                      {% if value is string %}
                        {% set tag_strings = tag_strings + [ (key ~ ':' ~ value)|lower ] %}
                      {% elif value is sequence %}
                        {% for item in value %}
                          {% set tag_strings = tag_strings + [ (key ~ ':' ~ item)|lower ] %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  {% set tag_strings = tag_strings + [module|string|lower] %}
                  <tr class="check-row"
                      data-index="{{ loop.index }}"
                      data-module="{{ module|string|lower }}"
                      data-severity="{{ check.severity|default('low')|lower }}"
                      data-status="{{ s }}"
                      data-tags="{{ tag_strings|join(' ')|e }}"
                      data-search="{{ (check.name ~ ' ' ~ check.id ~ ' ' ~ (check.command or '') ~ ' ' ~ (check.reason or ''))|lower|e }}"
                      data-id="{{ check.id|default('')|e }}"
                      data-name="{{ check.name|default('')|e }}"
                      data-command="{{ check.command|default('')|e }}"
                      data-assert="{{ check.assert_type|default('exact')|e }}"
                      data-expect="{{ expect_display|string|e }}"
                      data-reason="{{ check.reason|default('')|e }}"
                      data-output="{{ short_output(check.output)|e }}"
                      data-evidence="{{ check.evidence|default('')|e }}">
                    <td class="text-muted">{{ loop.index }}</td>
                    <td>
                      <div class="fw-semibold">{{ check.name }}</div>
                      <div class="small text-muted mono">ID: {{ check.id }}</div>
                      {% if check.command %}
                      <details class="small mt-1">
                        <summary class="text-muted">–ö–æ–º–∞–Ω–¥–∞</summary>
                        <pre class="code-pre small-mono">{{ check.command }}</pre>
                      </details>
                      {% endif %}
                    </td>
                    <td>{{ sev_badge(check.severity) }}</td>
                    <td>{{ result_badge(s) }}</td>
                    <td><span class="badge bg-secondary badge-pill mono">{{ check.assert_type|default('exact') }}</span></td>
                    <td><span class="mono small">{{ expect_display|safe }}</span></td>
                    <td>{{ fstec_badges(fl) }}</td>
                    <td class="text-end">
                      <button class="btn btn-sm btn-outline-primary" type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#output-{{ module_idx }}-{{ loop.index }}"
                              aria-expanded="false"
                              aria-controls="output-{{ module_idx }}-{{ loop.index }}">
                        –í—ã–≤–æ–¥
                      </button>
                    </td>
                  </tr>
                  <tr class="collapse" id="output-{{ module_idx }}-{{ loop.index }}">
                    <td colspan="8">
                      <pre class="code-pre mono mb-0">{{ short_output(check.output)|e }}</pre>
                      {% if check.reason %}
                        <div class="small text-muted mt-2">–ü—Ä–∏—á–∏–Ω–∞: {{ check.reason }}</div>
                      {% endif %}
                      {% if check.evidence %}
                        <div class="small text-muted">–£–ª–∏–∫–∞: {{ check.evidence }}</div>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {# ============== –°–í–û–î–ö–ê –ü–û –ú–ï–†–ê–ú –§–°–¢–≠–ö ‚Ññ21 ============== #}
    <hr class="my-4"/>

    <h2 class="h4 mb-3">–°–≤–æ–¥–∫–∞ –ø–æ –º–µ—Ä–∞–º –§–°–¢–≠–ö ‚Ññ21</h2>
    {% set fstek_summary = fstek_summary|default([], true) %}
    {% if fstek_summary %}
      <div class="table-responsive">
        <table class="table table-sm table-hover table-bordered align-middle sticky-header">
          <thead class="table-light">
            <tr>
              <th style="width:10ch;">–ú–µ—Ä–∞</th>
              <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
              <th class="text-end" style="width:8ch;">–í—Å–µ–≥–æ</th>
              <th class="text-end text-success" style="width:8ch;">Pass</th>
              <th class="text-end text-danger" style="width:8ch;">Fail</th>
              <th class="text-end text-warning" style="width:8ch;">Error</th>
            </tr>
          </thead>
          <tbody>
            {% for item in fstek_summary %}
              <tr>
                <td><span class="badge bg-info text-dark">{{ item.code }}</span></td>
                <td>{{ item.description|default('‚Äî') }}</td>
                <td class="text-end">{{ item.total }}</td>
                <td class="text-end">{{ item.passed }}</td>
                <td class="text-end">{{ item.failed }}</td>
                <td class="text-end">{{ item.errored }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">–¢–µ–≥–∏ –§–°–¢–≠–ö ‚Ññ21 –≤ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
    {% endif %}

    {# ============== –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (HIGH) –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø ============== #}
    {% set highs = high_findings|default([], true) %}

    <hr class="my-4"/>
    <h2 class="h4">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (High)</h2>
    {% if highs %}
      <div class="list-group mb-5">
        {% for r in highs %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">{{ r.name }}</div>
            <div>{{ sev_badge(r.severity) }}</div>
          </div>
          <div class="small text-muted mono">ID: {{ r.id }} ¬∑ –ú–æ–¥—É–ª—å: {{ r.module }}</div>
          {% set fl = r|fstek_details %}
          <div class="mt-2">
            <span class="text-muted small">–ú–µ—Ä—ã –§–°–¢–≠–ö ‚Ññ21:</span>
            <div class="small fw-semibold mt-1">{{ fstec_summary(fl)|safe }}</div>
          </div>
          {% if r.expect %}
          <div class="small mt-2"><span class="text-muted">–û–∂–∏–¥–∞–Ω–∏–µ:</span> <span class="mono">{{ format_expect(r.expect)|safe }}</span></div>
          {% endif %}
          <div class="small mt-1"><span class="text-muted">Assert:</span> <span class="badge bg-secondary mono">{{ r.assert_type|default('exact') }}</span></div>
          {% if r.command %}
          <details class="mt-2">
            <summary class="text-muted">–ö–æ–º–∞–Ω–¥–∞</summary>
            <pre class="code-pre small-mono">{{ r.command }}</pre>
          </details>
          {% endif %}
          <details class="mt-2">
            <summary class="text-muted">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥</summary>
            <pre class="code-pre mono">{{ r.output|default('‚Äî', true)|trim }}</pre>
          </details>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-5">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ.</p>
    {% endif %}

  </div> <!-- /container -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('filter-search');
      const severitySelect = document.getElementById('filter-severity');
      const statusSelect = document.getElementById('filter-status');
      const tagsInput = document.getElementById('filter-tags');
      const exportCsvBtn = document.getElementById('export-csv');
      const exportJsonBtn = document.getElementById('export-json');
      const rows = Array.from(document.querySelectorAll('.check-row'));

      if (!rows.length) {
        return;
      }

      const normalize = (value) => (value || '').toLowerCase();

      function toggleDetailRow(row, visible) {
        const detailRow = row.nextElementSibling;
        if (!detailRow || !detailRow.classList.contains('collapse')) {
          return;
        }
        if (!visible) {
          detailRow.classList.remove('show');
          detailRow.style.display = 'none';
        } else {
          detailRow.style.display = '';
        }
      }

      function applyFilters() {
        const query = normalize(searchInput ? searchInput.value : '');
        const severity = severitySelect ? severitySelect.value : 'all';
        const status = statusSelect ? statusSelect.value : 'all';
        const tagsRaw = normalize(tagsInput ? tagsInput.value : '');
        const tagTokens = tagsRaw.split(/[,\s]+/).filter(Boolean);

        rows.forEach((row) => {
          let visible = true;
          const rowSeverity = normalize(row.dataset.severity);
          const rowStatus = normalize(row.dataset.status);
          const rowTags = normalize(row.dataset.tags);
          const rowSearch = normalize(row.dataset.search);

          if (severity !== 'all' && rowSeverity !== severity) {
            visible = false;
          }

          if (status !== 'all' && rowStatus !== status) {
            visible = false;
          }

          if (tagTokens.length && !tagTokens.every((token) => rowTags.includes(token))) {
            visible = false;
          }

          if (query && !rowSearch.includes(query)) {
            visible = false;
          }

          row.style.display = visible ? '' : 'none';
          toggleDetailRow(row, visible);
        });
      }

      function gatherRowData(row) {
        return {
          id: row.dataset.id || '',
          name: row.dataset.name || '',
          module: row.dataset.module || '',
          severity: row.dataset.severity || '',
          status: row.dataset.status || '',
          assert: row.dataset.assert || '',
          expect: row.dataset.expect || '',
          tags: row.dataset.tags || '',
          command: row.dataset.command || '',
          reason: row.dataset.reason || '',
          output: row.dataset.output || '',
          evidence: row.dataset.evidence || ''
        };
      }

      function visibleRows() {
        return rows.filter((row) => row.style.display !== 'none');
      }

      function downloadFile(content, filename, mime) {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function exportCsv() {
        const data = visibleRows().map(gatherRowData);
        if (!data.length) {
          return;
        }
        const headers = ['id','name','module','severity','status','assert','expect','tags','command','reason','output','evidence'];
        const escapeValue = (value) => '"' + String(value ?? '').replace(/"/g, '""') + '"';
        let csv = headers.map(escapeValue).join(',') + '\n';
        data.forEach((row) => {
          csv += headers.map((key) => escapeValue(row[key])).join(',') + '\n';
        });
        downloadFile('\ufeff' + csv, 'secaudit-checks.csv', 'text/csv;charset=utf-8;');
      }

      function exportJson() {
        const data = visibleRows().map(gatherRowData);
        if (!data.length) {
          return;
        }
        downloadFile(JSON.stringify(data, null, 2), 'secaudit-checks.json', 'application/json;charset=utf-8;');
      }

      if (searchInput) { searchInput.addEventListener('input', applyFilters); }
      if (severitySelect) { severitySelect.addEventListener('change', applyFilters); }
      if (statusSelect) { statusSelect.addEventListener('change', applyFilters); }
      if (tagsInput) { tagsInput.addEventListener('input', applyFilters); }
      if (exportCsvBtn) { exportCsvBtn.addEventListener('click', exportCsv); }
      if (exportJsonBtn) { exportJsonBtn.addEventListener('click', exportJson); }

      applyFilters();
    });
  </script>
</body>
</html>
